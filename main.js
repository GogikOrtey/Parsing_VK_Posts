import fetch from 'node-fetch';
import fs from 'fs';
import https from 'https';
import moment from 'moment';
import crypto from 'crypto';
import sharp from 'sharp';



// –ö–ª—é—á –¥–æ—Å—Ç—É–ø–∞ –∫ API
const accessToken = '37382a8c37382a8c37382a8ca9342001943373837382a8c5108cd6d715313038c2969d4';

console.log(" ")
console.log("‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî")
console.log("v0.1")


// ID –≥—Ä—É–ø–ø—ã –í–ö–æ–Ω—Ç–∞–∫—Ç–µ
const groupId = '224924750';


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ö–µ—à–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
function createHash(buffer) {
    return crypto.createHash('sha256').update(buffer).digest('hex');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –∏–∑ —Ö–µ—à–∞
function createFileName(hash) {
    return hash.slice(0, 10);
}

    // –í—ã–≤–µ—Å—Ç–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    // –í—ã–≤–µ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
    // –í—ã–≤–µ—Å—Ç–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤, –∫–æ—Ç–æ—Ä–æ–µ –º—ã –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º
    // –í—ã–≤–µ—Å—Ç–∏ offset
    // –í—ã–≤–µ—Å—Ç–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –º—ã –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å

let bool_isHttpGerResponse = false; // –ù—É–∂–µ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–∫–∏ –æ –≤—Ä–µ–º–µ–Ω–∏ http –æ—Ç–≤–µ—Ç–∞
let bool_isinfoShow = false;        // –ï—Å–ª–∏ = true, —Ç–æ –≤ –∫–æ–Ω—Å–æ–ª—å –±—É–¥—É—Ç –≤—ã–≤–æ–¥–∏—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

// –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ—Å—Ç—ã –∏–∑ –≥—Ä—É–ø–ø—ã
// –ó–¥–µ—Å—å, "count=" - —ç—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤–µ—Ä–Ω—ë—Ç –Ω–∞–º —Å–µ—Ä–≤–µ—Ä max=100
// "offset=_" - —ç—Ç–æ —Å–¥–≤–∏–≥, –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–∞–º —Å–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–∏—Ç –ø–æ—Å—Ç—ã

let count = 5
let offset = 0

fetch(`https://api.vk.com/method/wall.get?
owner_id=-${groupId}&
count=${count}&
offset=${offset}&
access_token=${accessToken}&
v=5.130`)
    .then(res => res.json())
    .then(json => {

        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –ø–æ—Å—Ç–æ–≤:
        let int_insCountOfThePost = 0;
        console.log("count = " + count)
        console.log("offset = " + offset)
        console.log("")

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –ø–æ—Å—Ç
        json.response.items.forEach(item => {
            int_insCountOfThePost++;    // ‚Ññ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º–æ–≥–æ –ø–æ—Å—Ç–∞, –Ω–∞—á–∏–Ω–∞—è —Å 1

            // –í—ã–≤–æ–¥–∏–º –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å—Ç–µ
            //console.log("üìö –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ—Å—Ç–µ: ", item);

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞
            const postDateTime = moment.unix(item.date).format('YYYY.MM.DD HH‚Åömm');

                /*////////////////////////////////////
                //      –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –≤ –ø–æ—Å—Ç–µ      //
                ////////////////////////////////////*/

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ –ø–æ—Å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏–ª–∏ –ø–µ—Ä–µ—Å–ª–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã
            let attachments = 'attachments' in item ? item.attachments : [];


            if ('copy_history' in item && item.copy_history.length > 0) {
                if ('attachments' in item.copy_history[0]) {
                    // –ï—Å–ª–∏ –ø–µ—Ä–µ—Å–ª–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã –µ—Å—Ç—å, —Ç–æ –º—ã —Å–æ–≤–º–µ—â–∞–µ–º –∏—Ö –∏—Å—Ç–æ—Ä–∏—é, –ø–æ–∑–≤–æ–ª—è—è –Ω–∞—à–µ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ 
                    // –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏ –∏–∑ —ç—Ç–∏—Ö –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
                    attachments = attachments.concat(item.copy_history[0].attachments);
                }
            }

            const photos = attachments.filter(attachment => attachment.type === 'photo');

            let bool_ismultiplyPhotosInThePost = false; // = true, –µ—Å–ª–∏ –≤ –ø–æ—Å—Ç–µ > 1 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
            let countImage = 1;
            
            if (photos.length > 1) {
                console.log("üìö –í –ø–æ—Å—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π");
                bool_ismultiplyPhotosInThePost = true;
            }

                /*////////////////////////////////////
                //     –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –≤ –ø–æ—Å—Ç–µ     //
                ////////////////////////////////////*/

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ –ø–æ—Å—Ç–µ —Ç–µ–∫—Å—Ç
            let postText = 'text' in item ? item.text : '';

            if ('copy_history' in item && item.copy_history.length > 0) {
                if ('text' in item.copy_history[0]) {

                    // –°–æ–≤–º–µ—â–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –ø–æ—Å—Ç–∞ –∏ –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –ø–æ—Å—Ç–∞
                    if(postText != '' && (item.copy_history[0].text != '')) {
                        postText += '\n‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\n' + item.copy_history[0].text;
                    } else if(postText == '' && (item.copy_history[0].text != '')) {
                        postText += item.copy_history[0].text;
                    }
                }
            }

            if (postText != '') {
                let fileName = '[' + postDateTime + ']';
                let path = `img/${fileName}.txt`; 

                // –°–æ—Ö—Ä–∞–Ω—è—é —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –≤ –ø–∞–ø–∫–µ img
                fs.writeFile(path, postText, err => {
                    if (err) throw err;
                    console.log("üìÑ –¢–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª —Å –∏–º–µ–Ω–µ–º " + fileName + " —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –ø–∞–ø–∫–µ img");

                    // –ü–æ–ª—É—á–∞—é timestamp –∏–∑ postDateTime
                    let timestamp = moment(postDateTime, 'YYYY.MM.DD HH‚Åömm').valueOf();

                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞
                    fs.utimes(path, timestamp / 1000, timestamp / 1000, (err) => {
                        if (err) throw err;
                        if(bool_isinfoShow) console.log("‚è∞ –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞ " + fileName + 
                            " —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ " + postDateTime);
                    });
                });
            }


                /*////////////////////////////////////
                //              –î—Ä—É–≥–æ–µ              //
                ////////////////////////////////////*/

            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥–æ–µ –≤–ª–æ–∂–µ–Ω–∏–µ, –∏ –≤—ã–≤–æ–¥–∏–º –µ–≥–æ —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞                                   
            attachments.forEach(attachment => {
                // –í—ã–≤–æ–¥–∏–º —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                console.log(`–ü–æ—Å—Ç ‚Ññ${int_insCountOfThePost} –¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞: `, attachment.type);                
            });
            console.log("") 



            // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –≤–∏–¥–µ–æ
                // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ —Å –≤–∏–¥–µ–æ –∏ —Å –∫–ª–∏–ø–∞–º–∏
            // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É gif

            // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ–ø—Ä–æ—Å–æ–≤




            // –î–ª—è –≤—Å–µ—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –≤ –ø–æ–ª—É—á–µ–Ω–Ω–æ–º –Ω–∞–±–æ—Ä–µ:
            photos.forEach(photoAttachment => {
                // –í—ã–≤–æ–¥–∏–º –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
                //console.log("üìö –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏: ", photoAttachment.photo);

                // –ü–æ–ª—É—á–∞–µ–º URL —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º
                const photo = photoAttachment.photo;
                const photoUrl = photo.sizes[photo.sizes.length - 1].url;

                // –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –∫–∞—Ä—Ç–∏–Ω–∫–∏, –ø–æ —Å—Å—ã–ª–∫–∞–º, –ø–æ–ª—É—á–µ–Ω–Ω—ã–º –∏–∑ –ø–æ—Å—Ç–∞
                // –≠—Ç–∏ –∑–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
                https.get(photoUrl, response => {
                    // –í —Å—Ä–µ–¥–Ω–µ–º - 2.2 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å
                    if(bool_isHttpGerResponse == false) {
                        bool_isHttpGerResponse = true;
                        // –í—ã–≤–æ–∂—É —ç—Ç–æ, —á—Ç–æ –±—ã –ø–æ–º–Ω–∏—Ç—å –æ —Ç–æ–º, —á—Ç–æ https.get —è–≤–ª—è–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
                        //console.log(" ")
                        console.log(" ")
                        console.log("üïì")
                    }

                    let data = [];

                    response.on('data', chunk => {
                        data.push(chunk);
                    }).on('end', () => {
                        let buffer = Buffer.concat(data);           // –°–æ–±–∏—Ä–∞–µ–º –∫—É—Å–æ—á–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –æ–¥–Ω–æ

                        //let hash = createHash(buffer);            // –í—ã—á–∏—Å–ª—è–µ–º —Ö–µ—à –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        //console.log("hash = " + hash)

                        let fileName = '[' + postDateTime + ']';  // –ó–∞–¥–∞—é –∏–º—è –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        if (bool_ismultiplyPhotosInThePost === true) {
                            // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–µ—Å–∫–æ–ª—å–∫–æ, —Ç–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–¥–∞—é –µ–≥–æ –Ω–æ–º–µ—Ä –≤ –ø–æ—Å—Ç–µ
                            fileName += " - " + countImage;
                            countImage++;
                        }
                        //fileName += createFileName(hash) + ".jpg";// –ò–º—è —Å —Ö–µ—à–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        fileName += ".jpg";                         // –ò–º—è –±–µ–∑ —Ö–µ—à–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

                        let path = `img/${fileName}`;               // –ü—É—Ç—å, –∫—É–¥–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

                        // –ö–∏–¥–∞—é –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ —Ç–∞–∫–æ–π —Ñ–∞–π–ª —É–∂–µ –µ—Å—Ç—å –≤ —ç—Ç–æ–π –ø–∞–ø–∫–µ
                        if (fs.existsSync(path)) {
                            console.log("‚ö†Ô∏è –§–∞–π–ª —Å –∏–º–µ–Ω–µ–º " + fileName + " —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ø–∞–ø–∫–µ img, –∏ –±—É–¥–µ—Ç –∑–∞–º–µ–Ω—ë–Ω");
                        }

                        // –°–æ—Ö—Ä–∞–Ω—è—é —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –ø–∞–ø–∫–µ img
                        fs.writeFile(path, buffer, err => {
                            if (err) throw err;
                            console.log("‚úÖ –§–∞–π–ª —Å –∏–º–µ–Ω–µ–º " + fileName + " —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –ø–∞–ø–∫–µ img");

                            // –ü–æ–ª—É—á–∞—é timestamp –∏–∑ postDateTime
                            let timestamp = moment(postDateTime, 'YYYY.MM.DD HH‚Åömm').valueOf();

                            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞
                            fs.utimes(path, timestamp / 1000, timestamp / 1000, (err) => {
                                if (err) throw err;
                                if(bool_isinfoShow) console.log("‚è∞ –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞ " + fileName + 
                                    " —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ " + postDateTime);
                            });
                        });
                    });
                });
            });
        });
    });







// –ü–æ—Ç–æ–º:
// ‚Ä¢ –í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–≤–æ–¥, –∫–∞–∫–æ–π —ç—Ç–æ –ø–æ—Å—Ç –ø–æ –Ω–æ–º–µ—Ä—É, —Å —Å–∞–º–æ–≥–æ –≤–µ—Ä—Ö–∞
// ‚Ä¢ –í –Ω–∞—á–∞–ª–µ –≤—ã–≤–µ—Å—Ç–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Å–µ—Ö –ø–æ—Å—Ç–æ–≤ –≤ –≥—Ä—É–ø–ø–µ
// ‚Ä¢ –°–¥–µ–ª–∞—Ç—å –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É –ø–æ—Å—Ç–æ–≤, –Ω–∞–ø—Ä–∏–º–µ—Ä –ø–æ 20 —à—Ç—É–∫

















